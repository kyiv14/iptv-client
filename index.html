<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Вход и Регистрация</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --system-blue: #007AFF;
            --system-gray-light: #F2F2F7;
            --system-green: #34C759;
            --system-red: #FF3B30;
        }

        /* Общие стили и фон */
        body {
            font-family: 'Montserrat', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
            color: #333;
        }
        
        /* КНОПКИ В ПРАВОМ ВЕРХНЕМ УГЛУ */
        .auth-buttons-container {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
            z-index: 110;
        }
        
        .auth-btn {
            padding: 10px 15px;
            border: none;
            border-radius: 8px;
            background: rgba(0, 123, 255, 0.8);
            color: white;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s ease;
        }
        
        .auth-btn:hover {
            background: var(--system-blue);
        }

        .form-container {
            background: #ffffff;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            max-width: 450px;
            width: 100%;
            display: none;
        }

        h1 {
            color: #444;
            margin-bottom: 35px;
            font-weight: 600;
            text-align: center;
            font-size: 24px;
        }

        .input-group-modern {
            position: relative;
            margin-bottom: 35px;
        }

        .input-group-modern input {
            width: 100%;
            padding: 15px 10px 5px 10px;
            background: none;
            border: none;
            border-bottom: 2px solid #ccc;
            font-size: 16px;
            color: #333;
            outline: none;
            transition: border-bottom-color 0.3s ease;
        }

        .input-group-modern input:focus,
        .input-group-modern input:not(:placeholder-shown) {
            border-bottom-color: var(--system-blue);
        }

        .input-group-modern label {
            position: absolute;
            top: 15px;
            left: 10px;
            color: #999;
            font-size: 16px;
            pointer-events: none;
            transition: all 0.3s ease;
        }

        .input-group-modern input:focus + label,
        .input-group-modern input:not(:placeholder-shown) + label {
            top: -10px;
            left: 0;
            font-size: 12px;
            color: var(--system-blue);
        }

        .submit-btn-modern {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 8px;
            background: var(--system-blue); 
            color: white;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0, 123, 255, 0.4);
            transition: all 0.3s ease;
            overflow: hidden;
            position: relative;
            z-index: 1;
        }

        .submit-btn-modern:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 123, 255, 0.6);
        }

        .submit-btn-modern:active {
            transform: translateY(0);
            box-shadow: 0 2px 10px rgba(0, 123, 255, 0.4);
        }
        
        .status-message {
            margin-top: 15px;
            padding: 10px;
            border-radius: 6px;
            text-align: center;
            font-size: 15px;
            display: none;
        }
        
        .status-message.success {
            background-color: #e6ffe6;
            color: var(--system-green);
        }
        
        .status-message.error {
            background-color: #ffe6e6;
            color: var(--system-red);
        }
        
        /* Стили для модальных окон */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 100;
            justify-content: center;
            align-items: center;
            padding: 20px 0;
            overflow-y: auto;
        }
        
        .modal-content {
            background: white;
            width: 90%;
            max-width: 400px;
            border-radius: 14px;
            padding: 25px;
            animation: modalOpen 0.3s ease-out;
            position: relative;
        }
        
        @keyframes modalOpen {
            from { transform: scale(0.9); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h2 {
            font-size: 20px;
            color: var(--system-blue);
            margin: 0;
        }

        .close-btn {
            font-size: 28px;
            cursor: pointer;
            line-height: 1;
            position: absolute;
            top: 15px;
            right: 20px;
            color: #666;
        }

        /* Дополнительные стили для модального окна результата плейлиста */
        .link-result-link {
            background: var(--system-gray-light);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            word-break: break-all;
            text-align: center;
            font-size: 16px;
            font-weight: 500;
        }
        
        .link-result-actions {
            display: flex;
            gap: 12px;
            flex-direction: column;
        }
        
        .link-result-actions button {
            width: 100%;
            /* ИЗМЕНЕНИЯ СЮДА */
            font-size: 20px; /* Увеличенный шрифт */
            padding: 15px;
            border-radius: 8px;
            color: white; /* Белый цвет шрифта */
            font-weight: 700; /* Жирный шрифт */
            /* КОНЕЦ ИЗМЕНЕНИЙ */
        }

    </style>
</head>
<body>

    <div class="auth-buttons-container">
        <button class="auth-btn" onclick="openModal('registrationModal')">Регистрация</button>
        <button class="auth-btn" onclick="openModal('loginModal')">Вход</button>
    </div>

    <div style="text-align: center; opacity: 0.5;">
        <h1 style="color: #666;">Добро пожаловать</h1>
        <p>Для доступа к плейлистам войдите или зарегистрируйтесь.</p>
    </div>


    <div id="registrationModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('registrationModal')">×</span>
            <h1>Регистрация</h1>

            <form id="registrationForm" onsubmit="return false;">
                <div class="input-group-modern">
                    <input type="text" id="clientName" required placeholder=" ">
                    <label for="clientName">Ваше имя</label>
                </div>

                <div class="input-group-modern">
                    <input type="tel" id="clientPhone" required placeholder=" ">
                    <label for="clientPhone">Номер телефона</label>
                </div>

                <div class="input-group-modern">
                    <input type="password" id="clientPassword" required placeholder=" ">
                    <label for="clientPassword">Пароль</label>
                </div>

                <div class="input-group-modern">
                    <input type="password" id="clientPasswordRepeat" required placeholder=" ">
                    <label for="clientPasswordRepeat">Повторите пароль</label>
                </div>

                <button type="submit" class="submit-btn-modern" id="registerBtn">
                    Зарегистрироваться
                </button>
                <div id="statusMessage" class="status-message"></div>
            </form>
        </div>
    </div>


    <div id="loginModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('loginModal')">×</span>
            <h2 style="text-align: center; margin-bottom: 20px;">Вход</h2>
            <form id="loginForm" onsubmit="return false;">
                <div class="input-group-modern">
                    <input type="tel" id="loginPhone" required placeholder=" ">
                    <label for="loginPhone">Номер телефона</label>
                </div>
                <div class="input-group-modern">
                    <input type="password" id="loginPassword" required placeholder=" ">
                    <label for="loginPassword">Пароль</label>
                </div>
                <button type="submit" id="loginBtn" class="submit-btn-modern">Войти</button>
            </form>
            <div id="loginStatusMessage" class="status-message"></div>
        </div>
    </div>


    <div id="linkDisplayModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('linkDisplayModal')">×</span>
            <div class="modal-header">
                <h2>Ваш плейлист</h2>
            </div>
            
            <div class="link-result-content" style="text-align: center;">
                <h3 style="margin-top: 0;">Короткая ссылка:</h3>
                <div class="link-result-link" id="finalPlaylistLink">Загрузка...</div>
            </div>
            
            <div class="link-result-actions">
                <button id="copyLinkBtn" style="background: var(--system-blue);">Копировать ссылку</button>
                <button id="downloadLinkBtn" style="background: var(--system-green);">Скачать файл</button>
            </div>
        </div>
    </div>


    <script>
        // =================================================================
        // КОНФИГУРАЦИЯ GITHUB И VERCEL
        // =================================================================
        
        // ВАШ ТОКЕН И ДАННЫЕ РЕПОЗИТОРИЯ
        const TOKEN_PARTS = ["ghp_to27A4", "Q0SrXyfBANG1", "fxQvzyhhgwrn0rm1ra"];
        const REPO_CONFIG = {
            owner: "kyiv14",
            repo: "moe-iptv",
            branch: "main",
            clientsFile: "public/clients.json",
            samplePlaylist: "https://moe-iptv.vercel.app/sample.m3u", 
            baseUrl: "https://moe-iptv.vercel.app/"
        };
        
        // Переменные для хранения данных после регистрации/входа
        let currentClientData = null; 
        let currentPlaylistResult = null;
        
        function getGitHubToken() {
            return TOKEN_PARTS.join('');
        }

        // =================================================================
        // ВСПОМОГАТЕЛЬНЫЕ ФУНКЦИИ
        // =================================================================

        function extractPhoneNumber(phone) {
            const digits = phone.replace(/\D/g, '');
            return digits.slice(-10);
        }

        function openModal(modalId) {
            document.querySelectorAll('.modal').forEach(modal => {
                modal.style.display = 'none';
            });
            document.getElementById(modalId).style.display = 'flex';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function showStatus(message, type, elementId = 'statusMessage') {
            const statusEl = document.getElementById(elementId);
            statusEl.innerHTML = message;
            statusEl.className = 'status-message ' + type;
            statusEl.style.display = 'block';
        }

        function copyToClipboard(text, event) {
            event.preventDefault();
            navigator.clipboard.writeText(text).catch(err => {
                console.error('Ошибка копирования: ', err);
            });
            alert('Ссылка скопирована!');
            return false;
        }
        
        function forceDownload(url, filename) {
            fetch(url)
                .then(response => response.blob())
                .then(blob => {
                    const blobUrl = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = blobUrl;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    setTimeout(() => {
                        document.body.removeChild(a);
                        window.URL.revokeObjectURL(blobUrl);
                    }, 100);
                })
                .catch(error => console.error('Ошибка при скачивании файла:', error));
        }


        // =================================================================
        // ЛОГИКА GITHUB/API
        // =================================================================
        
        // ** ИСПРАВЛЕННАЯ ФУНКЦИЯ **: Получает SHA конкретного файла (для .m3u или .json)
        async function getFileSha(filename) {
            const apiUrl = `https://api.github.com/repos/${REPO_CONFIG.owner}/${REPO_CONFIG.repo}/contents/${filename}`;
            try {
                const response = await fetch(apiUrl, {
                    headers: {
                        'Authorization': `Bearer ${getGitHubToken()}`,
                        'Accept': 'application/vnd.github+json'
                    }
                });
                if (response.ok) {
                    const data = await response.json();
                    return data.sha;
                }
                // Если файл не существует (404), возвращаем null (для создания нового)
                if (response.status === 404) {
                    return null;
                }
                throw new Error(`Ошибка при получении SHA: ${response.statusText}`);
            } catch (error) {
                console.error('Ошибка при получении SHA:', error);
                return null; 
            }
        }

        async function loadClientsFromGitHub() {
            const filename = REPO_CONFIG.clientsFile;
            const apiUrl = `https://api.github.com/repos/${REPO_CONFIG.owner}/${REPO_CONFIG.repo}/contents/${filename}`;
            try {
                const response = await fetch(apiUrl, {
                    headers: {
                        'Authorization': `Bearer ${getGitHubToken()}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                if (response.ok) {
                    const data = await response.json();
                    const content = decodeURIComponent(escape(atob(data.content)));
                    const clients = JSON.parse(content) || [];
                    return { clients, sha: data.sha };
                }
                if (response.status === 404) {
                    return { clients: [], sha: null };
                }
                throw new Error(`Ошибка загрузки: ${response.statusText}`);
            } catch (error) {
                throw error;
            }
        }

        async function createIsGdShortUrl(phone) {
            const cleanPhone = extractPhoneNumber(phone);
            const longUrl = `${REPO_CONFIG.baseUrl}${cleanPhone}.m3u`;
            try {
                const apiUrl = `https://is.gd/create.php?format=json&url=${encodeURIComponent(longUrl)}&shorturl=${cleanPhone}`;
                const response = await fetch(apiUrl);
                if (!response.ok) throw new Error("Сервис is.gd недоступен.");
                const data = await response.json();
                if (data.errorcode) return `https://is.gd/${cleanPhone}`;
                return data.shorturl;
            } catch (error) {
                console.error('Ошибка создания is.gd ссылки:', error);
                return longUrl;
            }
        }

        // 1. Создание/Обновление плейлиста (.m3u) на GitHub
        async function createPlaylist(phone, key) {
            const cleanPhone = extractPhoneNumber(phone);
            if (cleanPhone.length < 10) throw new Error("Номер должен содержать минимум 10 цифр.");
            const filename = `public/${cleanPhone}.m3u`;
            
            const response = await fetch(REPO_CONFIG.samplePlaylist);
            if (!response.ok) throw new Error("Не удалось загрузить образец плейлиста sample.m3u.");
            
            let content = await response.text();
            content = content.replace(/\/iptv\/\w+\//g, `/iptv/${key}/`);
            
            // ** ИСПРАВЛЕНИЕ **: Получаем SHA именно для файла плейлиста!
            const sha = await getFileSha(filename); 
            
            const apiUrl = `https://api.github.com/repos/${REPO_CONFIG.owner}/${REPO_CONFIG.repo}/contents/${filename}`;
            const uploadResponse = await fetch(apiUrl, {
                method: 'PUT',
                headers: {
                    'Authorization': `Bearer ${getGitHubToken()}`,
                    'Content-Type': 'application/json',
                    'Accept': 'application/vnd.github+json'
                },
                body: JSON.stringify({
                    message: `Обновление плейлиста: ${cleanPhone}`,
                    content: btoa(unescape(encodeURIComponent(content))),
                    branch: REPO_CONFIG.branch,
                    sha: sha // Используем SHA конкретного плейлиста
                })
            });
            
            if (!uploadResponse.ok) {
                const error = await uploadResponse.json();
                throw new Error(error.message || "Ошибка при загрузке плейлиста на GitHub");
            }

            const isgdUrl = await createIsGdShortUrl(phone);

            return {
                isgdUrl: isgdUrl,
                m3uFilename: `${cleanPhone}.m3u`,
                m3uContent: content
            };
        }

        // 2. Сохранение данных клиента в clients.json
        async function saveClientData(client) {
            let { clients: currentClients, sha } = await loadClientsFromGitHub();
            
            if (currentClients.some(c => c.phone === client.phone)) {
                throw new Error("Клиент с таким номером уже зарегистрирован.");
            }
            
            currentClients.push(client);

            const apiUrl = `https://api.github.com/repos/${REPO_CONFIG.owner}/${REPO_CONFIG.repo}/contents/${REPO_CONFIG.clientsFile}`;
            const response = await fetch(apiUrl, {
                method: 'PUT',
                headers: {
                    'Authorization': `Bearer ${getGitHubToken()}`,
                    'Content-Type': 'application/json',
                    'Accept': 'application/vnd.github+json'
                },
                body: JSON.stringify({
                    message: `Добавлен новый клиент: ${client.name}`,
                    content: btoa(unescape(encodeURIComponent(JSON.stringify(currentClients)))),
                    branch: REPO_CONFIG.branch,
                    sha: sha 
                })
            });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.message || "Ошибка при сохранении данных клиента.");
            }
            return true;
        }


        // =================================================================
        // ГЛАВНЫЕ ОБРАБОТЧИКИ
        // =================================================================

        document.addEventListener('DOMContentLoaded', () => {
            const loginForm = document.getElementById('loginForm');
            
            // --- ОБРАБОТЧИК РЕГИСТРАЦИИ ---
            document.getElementById('registrationForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const name = document.getElementById('clientName').value.trim();
                const phone = document.getElementById('clientPhone').value.trim();
                const password = document.getElementById('clientPassword').value;
                const passwordRepeat = document.getElementById('clientPasswordRepeat').value;
                const statusEl = document.getElementById('statusMessage');

                const cleanPhoneDigits = extractPhoneNumber(phone);
                const defaultKey = '0000000000'; 
                const defaultMonths = '1';
                const defaultPaymentDate = new Date().toISOString().split('T')[0];
                
                statusEl.style.display = 'none';

                if (!name || !phone || !password || !passwordRepeat || password !== passwordRepeat || password.length < 6 || cleanPhoneDigits.length < 10) {
                    showStatus("Проверьте поля: заполнены, пароли совпадают (мин. 6 симв.), телефон (мин. 10 цифр).", "error", 'statusMessage');
                    return;
                }

                const newClient = {
                    name: name,
                    phone: cleanPhoneDigits,
                    password: password, 
                    key: defaultKey,
                    paymentDate: defaultPaymentDate,
                    months: defaultMonths,
                    registration_date: new Date().toISOString()
                };

                try {
                    // 1. Создание плейлиста (.m3u)
                    currentPlaylistResult = await createPlaylist(phone, defaultKey);

                    // 2. Сохранение клиента в clients.json
                    await saveClientData(newClient);
                    
                    currentClientData = newClient;
                    
                    // 3. Очистка формы и показ модального окна входа
                    document.getElementById('registrationForm').reset();
                    closeModal('registrationModal');

                    // Автоматически заполняем поля входа для удобства
                    document.getElementById('loginPhone').value = phone; 
                    document.getElementById('loginPassword').value = password; 

                    openModal('loginModal');

                } catch (error) {
                    showStatus(`❌ Произошла ошибка: ${error.message}`, "error", 'statusMessage');
                    console.error('Ошибка при регистрации:', error);
                }
            });

            // --- ОБРАБОТЧИК ВХОДА (РАБОТАЕТ ЧЕРЕЗ КНОПКУ И ENTER) ---
            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const loginPhone = document.getElementById('loginPhone').value.trim();
                const loginPassword = document.getElementById('loginPassword').value;
                const loginStatusEl = document.getElementById('loginStatusMessage');
                loginStatusEl.style.display = 'none';

                const cleanLoginPhoneDigits = extractPhoneNumber(loginPhone);
                
                if (!loginPhone || !loginPassword) {
                    showStatus('Заполните все поля для входа.', "error", 'loginStatusMessage');
                    return;
                }

                try {
                    // 1. Загрузка данных клиентов
                    const { clients } = await loadClientsFromGitHub();
                    
                    // 2. Поиск клиента по номеру и паролю
                    const client = clients.find(c => c.phone === cleanLoginPhoneDigits && c.password === loginPassword);
                    
                    if (client) {
                        currentClientData = client;
                        
                        // 3. Создаем/обновляем плейлист, чтобы получить актуальную ссылку/контент
                        currentPlaylistResult = await createPlaylist(loginPhone, client.key || '0000000000'); 

                        // 4. Показываем модальное окно со ссылкой
                        document.getElementById('finalPlaylistLink').textContent = currentPlaylistResult.isgdUrl;
                        
                        const tempUrl = URL.createObjectURL(new Blob([currentPlaylistResult.m3uContent], { type: 'application/x-mpegurl' }));
                        
                        document.getElementById('copyLinkBtn').onclick = (e) => copyToClipboard(currentPlaylistResult.isgdUrl, e);
                        document.getElementById('downloadLinkBtn').onclick = () => {
                            forceDownload(tempUrl, currentPlaylistResult.m3uFilename);
                        };

                        closeModal('loginModal');
                        openModal('linkDisplayModal');
                        
                    } else {
                        showStatus('Неверный номер телефона или пароль.', "error", 'loginStatusMessage');
                    }
                } catch (error) {
                    showStatus(`❌ Ошибка входа: ${error.message}`, "error", 'loginStatusMessage');
                    console.error('Ошибка при входе:', error);
                }
            });
        });

        window.openModal = openModal;
        window.closeModal = closeModal;
    </script>
</body>
</html>