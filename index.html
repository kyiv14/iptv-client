<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Доступное IPTV | Вход и Регистрация</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;700;900&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --system-blue: #007AFF;
            --system-gray-light: #F2F2F7;
            --system-green: #34C759;
            --system-red: #FF3B30;
            --blue-hover: #0056b3;
            --green-hover: #218838;
        }

        /* Общие стили и фон */
        body {
            font-family: 'Montserrat', sans-serif;
            background: #FFFFFF;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
            color: #333;
            flex-direction: column;
            position: relative;
        }
        
        /* АНИМАЦИЯ ПОЯВЛЕНИЯ ЭЛЕМЕНТОВ */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* КОНТЕЙНЕР ОСНОВНОГО КОНТЕНТА */
        .main-content {
            max-width: 700px;
            text-align: center;
            padding: 20px;
            margin-top: 50px; 
            margin-bottom: 50px; 
            opacity: 0;
            animation: fadeIn 0.8s ease-out forwards;
            animation-delay: 0.2s;
        }

        .main-content h1 {
            font-size: 38px;
            color: var(--system-blue);
            margin-bottom: 20px;
            font-weight: 700;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .main-content p {
            font-size: 18px;
            color: #555;
            line-height: 1.6;
            margin-bottom: 30px;
        }
        
        /* =================================================== */
        /* СТИЛИ БЛОКА "КАК ПОДКЛЮЧИТЬ IPTV" */
        /* =================================================== */
        .how-to-connect-block {
            max-width: 1000px;
            width: 100%;
            padding: 30px 20px;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            opacity: 0;
            animation: fadeIn 0.8s ease-out forwards;
            animation-delay: 0.5s;
            margin-bottom: 40px; 
        }

        .how-to-connect-block h2 {
            font-size: 28px;
            font-weight: 700;
            text-align: center;
            margin-bottom: 40px;
            color: #333;
        }

        .steps-container {
            display: flex;
            justify-content: space-around;
            gap: 20px;
            flex-wrap: wrap;
        }

        .step-item {
            flex-basis: 200px; 
            text-align: center;
            padding: 10px;
            transition: transform 0.3s ease;
        }
        
        .step-item:hover {
            transform: translateY(-5px);
        }

        .step-number {
            width: 40px;
            height: 40px;
            line-height: 40px;
            background: var(--system-blue); 
            color: white;
            border-radius: 50%;
            font-size: 20px;
            font-weight: 900;
            margin: 0 auto 15px;
            box-shadow: 0 4px 10px rgba(0, 123, 255, 0.4);
            transition: transform 0.3s ease;
        }
        
        .step-item:hover .step-number {
            transform: scale(1.1);
        }

        .step-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--system-blue);
            margin-bottom: 5px;
            text-transform: uppercase;
        }

        .step-description {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
            line-height: 1.4;
        }

        .step-description a {
             color: var(--system-blue);
             text-decoration: none;
             font-weight: 600;
             transition: color 0.2s ease;
        }
        
        .step-description a:hover {
             color: var(--blue-hover);
             text-decoration: underline;
        }

        /* =================================================== */
        /* СТИЛИ БЛОКА "ГДЕ РАБОТАЕТ IPTV?" */
        /* =================================================== */
        .where-it-works-block {
            max-width: 1000px;
            width: 100%;
            padding: 30px 20px;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            opacity: 0;
            animation: fadeIn 0.8s ease-out forwards;
            animation-delay: 0.8s;
            margin-bottom: 40px;
        }

        .where-it-works-block h2 {
            font-size: 28px;
            font-weight: 700;
            text-align: center;
            margin-bottom: 40px;
            color: #333;
        }

        .devices-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 30px 20px;
            justify-items: center;
            padding: 0 5%;
        }

        .device-item {
            text-align: center;
            padding: 10px;
            transition: transform 0.3s ease;
        }
        
        .device-item:hover {
            transform: translateY(-5px);
        }

        .device-icon {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: var(--system-blue); 
            margin: 0 auto 10px;
            box-shadow: 0 4px 10px rgba(0, 123, 255, 0.4);
        }
        
        .device-icon img {
            width: 70%;
            height: 70%;
            object-fit: contain;
        }

        .device-name {
            font-size: 14px;
            font-weight: 600;
            color: #333;
            text-transform: uppercase;
            margin-top: 5px;
        }
        
        /* Адаптивность для блока "Где работает" */
        @media (max-width: 768px) {
            .devices-container {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 500px) {
            .devices-container {
                grid-template-columns: 1fr;
            }
            .main-content {
                margin-top: 80px;
            }
            .main-content h1 {
                font-size: 32px;
                line-height: 1.2;
            }
            .main-content p {
                font-size: 18px;
            }
            .how-to-connect-block h2,
            .where-it-works-block h2 {
                font-size: 24px;
            }
            .step-title,
            .device-name {
                font-size: 16px;
            }
            .step-description {
                font-size: 15px;
            }
            .steps-container {
                gap: 30px;
            }
            .step-item {
                flex-basis: 90%;
            }
            .auth-buttons-container {
                top: 10px;
                right: 10px;
            }
        }

        /* =================================================== */
        /* КНОПКИ В ПРАВОМ ВЕРХНЕМ УГЛУ */
        /* =================================================== */
        .auth-buttons-container {
            position: fixed; 
            top: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
            z-index: 110;
        }
        
        .auth-btn {
            padding: 12px 18px; /* Увеличен паддинг */
            border: none;
            border-radius: 8px;
            background: var(--system-blue); /* Чистый синий фон */
            color: white;
            font-weight: 700; /* Жирный шрифт */
            cursor: pointer;
            transition: background 0.2s ease, transform 0.1s ease, box-shadow 0.2s ease;
            box-shadow: 0 4px 10px rgba(0, 123, 255, 0.4); /* Красивая тень */
        }
        
        .auth-btn:hover {
            background: var(--blue-hover);
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0, 123, 255, 0.5);
        }
        
        .auth-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 5px rgba(0, 123, 255, 0.4);
        }

        /* Отдельный стиль для кнопки Оплаты (зеленый) */
        .auth-btn-payment {
            background-color: var(--system-green) !important;
            box-shadow: 0 4px 10px rgba(52, 199, 89, 0.4) !important;
        }
        .auth-btn-payment:hover {
            background-color: var(--green-hover) !important;
            box-shadow: 0 6px 15px rgba(52, 199, 89, 0.5) !important;
        }
        .auth-btn-payment:active {
            box-shadow: 0 2px 5px rgba(52, 199, 89, 0.4) !important;
        }

        /* ... Стили форм и модальных окон (оставлены без изменений) ... */

        h1 {
            color: #444;
            margin-bottom: 35px;
            font-weight: 600;
            text-align: center;
            font-size: 24px;
        }

        .input-group-modern {
            position: relative;
            margin-bottom: 35px;
        }

        .input-group-modern input {
            width: 100%;
            padding: 15px 10px 5px 10px;
            background: none;
            border: none;
            border-bottom: 2px solid #ccc;
            font-size: 16px;
            color: #333;
            outline: none;
            transition: border-bottom-color 0.3s ease;
        }

        .input-group-modern input:focus,
        .input-group-modern input:not(:placeholder-shown) {
            border-bottom-color: var(--system-blue);
        }

        .input-group-modern label {
            position: absolute;
            top: 15px;
            left: 10px;
            color: #999;
            font-size: 16px;
            pointer-events: none;
            transition: all 0.3s ease;
        }

        .input-group-modern input:focus + label,
        .input-group-modern input:not(:placeholder-shown) + label {
            top: -10px;
            left: 0;
            font-size: 12px;
            color: var(--system-blue);
        }

        .submit-btn-modern {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 8px;
            background: var(--system-blue); 
            color: white;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0, 123, 255, 0.4);
            transition: all 0.3s ease;
            overflow: hidden;
            position: relative;
            z-index: 1;
        }

        .submit-btn-modern:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 123, 255, 0.6);
        }

        .submit-btn-modern:active {
            transform: translateY(0);
            box-shadow: 0 2px 10px rgba(0, 123, 255, 0.4);
        }
        
        .status-message {
            margin-top: 15px;
            padding: 10px;
            border-radius: 6px;
            text-align: center;
            font-size: 15px;
            display: none;
        }
        
        .status-message.success {
            background-color: #e6ffe6;
            color: var(--system-green);
        }
        
        .status-message.error {
            background-color: #ffe6e6;
            color: var(--system-red);
        }
        
        /* Стили для модальных окон */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 100;
            justify-content: center;
            align-items: center;
            padding: 20px 0;
            overflow-y: auto;
        }
        
        .modal-content {
            background: white;
            width: 90%;
            max-width: 400px;
            border-radius: 14px;
            padding: 25px;
            animation: modalOpen 0.3s ease-out;
            position: relative;
        }
        
        @keyframes modalOpen {
            from { transform: scale(0.9); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h2 {
            font-size: 20px;
            color: var(--system-blue);
            margin: 0;
        }

        .close-btn {
            font-size: 28px;
            cursor: pointer;
            line-height: 1;
            position: absolute;
            top: 15px;
            right: 20px;
            color: #666;
        }

        /* Дополнительные стили для модального окна результата плейлиста */
        .link-result-link {
            background: var(--system-gray-light);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            word-break: break-all;
            text-align: center;
            font-size: 16px;
            font-weight: 500;
        }
        
        .link-result-actions {
            display: flex;
            gap: 12px;
            flex-direction: column;
        }
        
        .link-result-actions button {
            width: 100%;
            font-size: 20px; 
            padding: 15px;
            border-radius: 8px;
            color: white; 
            font-weight: 700;
            border: none;
            outline: none;
            cursor: pointer;
            transition: background 0.2s ease, transform 0.1s ease;
        }
        
        /* Анимация при наведении и нажатии */
        #copyLinkBtn:hover {
            background: var(--blue-hover) !important;
            transform: translateY(-1px);
        }
        
        #downloadLinkBtn:hover {
            background: var(--green-hover) !important;
            transform: translateY(-1px);
        }

        #copyLinkBtn:active, #downloadLinkBtn:active {
            transform: translateY(0);
            opacity: 0.9;
        }

    </style>
</head>
<body>

    <div class="auth-buttons-container">
        <button class="auth-btn auth-btn-payment" onclick="alert('Переход на страницу оплаты. Настройте ссылку!')">Оплата</button>
        <button class="auth-btn" onclick="openModal('registrationModal')">Регистрация</button>
        <button class="auth-btn" onclick="openModal('loginModal')">Вход</button>
    </div>

    <div class="main-content">
        <h1>Доступное IPTV — 4000 каналов IPTV в отличном качестве с архивом.</h1>
        <p>Современный сервис IPTV телевидения, который дает возможность смотреть каналы в Full HD и Ultra HD качестве. Плейлист IPTV телевидения насчитывает 4000 IPTV каналов. Присоединяйтесь к нам и желаем Вам приятного просмотра</p>
    </div>

    <div class="how-to-connect-block">
        <h2>Как подключить IPTV</h2>
        <div class="steps-container">
            <div class="step-item">
                <div class="step-number">1</div>
                <div class="step-title">Регистрация</div>
                <div class="step-description">
                    Нажмите кнопку Регистрация в правом верхнем углу
                </div>
            </div>
            <div class="step-item">
                <div class="step-number">2</div>
                <div class="step-title">Оплата</div>
                <div class="step-description">Оплатить подписку</div>
            </div>
            <div class="step-item">
                <div class="step-number">3</div>
                <div class="step-title">Плейлист</div>
                <div class="step-description">Скачать плейлист</div>
            </div>
            <div class="step-item">
                <div class="step-number">4</div>
                <div class="step-title">Загрузка</div>
                <div class="step-description">Загрузить плейлист в Ваше устройство</div>
            </div>
        </div>
    </div>
    
    <div class="where-it-works-block">
        <h2>Где работает IPTV?</h2>
        <div class="devices-container">
            <div class="device-item">
                <div class="device-icon">
                    <img src="https://iptvclient.vercel.app/smartphone-call.png" alt="Смартфон">
                </div>
                <div class="device-name">На смартфоне</div>
            </div>
            <div class="device-item">
                <div class="device-icon">
                    <img src="https://iptvclient.vercel.app/computer-tablet.png" alt="Планшет">
                </div>
                <div class="device-name">На планшете</div>
            </div>
            <div class="device-item">
                <div class="device-icon">
                    <img src="https://iptvclient.vercel.app/tv-box.png" alt="ТВ приставка">
                </div>
                <div class="device-name">На ТВ приставке</div>
            </div>
            
            <div class="device-item">
                <div class="device-icon">
                    <img src="https://iptvclient.vercel.app/tv.png" alt="Smart TV">
                </div>
                <div class="device-name">На Smart TV телевизоре</div>
            </div>
            <div class="device-item">
                <div class="device-icon">
                    <img src="https://iptvclient.vercel.app/tv-tuner.png" alt="Спутниковый тюнер">
                </div>
                <div class="device-name">На спутниковом тюнере</div>
            </div>
            <div class="device-item">
                <div class="device-icon">
                    <img src="https://iptvclient.vercel.app/laptop.png" alt="Компьютер">
                </div>
                <div class="device-name">На компьютере и ноутбуке</div>
            </div>
        </div>
    </div>


    <div id="registrationModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('registrationModal')">×</span>
            <h1>Регистрация</h1>

            <form id="registrationForm" onsubmit="return false;">
                <div class="input-group-modern">
                    <input type="text" id="clientName" required placeholder=" ">
                    <label for="clientName">Ваше имя</label>
                </div>

                <div class="input-group-modern">
                    <input type="tel" id="clientPhone" required placeholder=" ">
                    <label for="clientPhone">Номер телефона</label>
                </div>

                <div class="input-group-modern">
                    <input type="password" id="clientPassword" required placeholder=" ">
                    <label for="clientPassword">Пароль</label>
                </div>

                <div class="input-group-modern">
                    <input type="password" id="clientPasswordRepeat" required placeholder=" ">
                    <label for="clientPasswordRepeat">Повторите пароль</label>
                </div>

                <button type="submit" class="submit-btn-modern" id="registerBtn">
                    Зарегистрироваться
                </button>
                <div id="statusMessage" class="status-message"></div>
            </form>
        </div>
    </div>


    <div id="loginModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('loginModal')">×</span>
            <h2 style="text-align: center; margin-bottom: 20px;">Вход</h2>
            <form id="loginForm" onsubmit="return false;">
                <div class="input-group-modern">
                    <input type="tel" id="loginPhone" required placeholder=" ">
                    <label for="loginPhone">Номер телефона</label>
                </div>
                <div class="input-group-modern">
                    <input type="password" id="loginPassword" required placeholder=" ">
                    <label for="loginPassword">Пароль</label>
                </div>
                <button type="submit" id="loginBtn" class="submit-btn-modern">Войти</button>
            </form>
            <div id="loginStatusMessage" class="status-message"></div>
        </div>
    </div>


    <div id="linkDisplayModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('linkDisplayModal')">×</span>
            <div class="modal-header">
                <h2>Ваш плейлист</h2>
            </div>
            
            <div class="link-result-content" style="text-align: center;">
                <h3 style="margin-top: 0; visibility: hidden; height: 0; line-height: 0;">Короткая ссылка:</h3> 
                <div class="link-result-link" id="finalPlaylistLink">Загрузка...</div>
            </div>
            
            <div class="link-result-actions">
                <button id="copyLinkBtn" style="background: var(--system-blue);">Копировать ссылку</button>
                <button id="downloadLinkBtn" style="background: var(--system-green);">Скачать файл</button>
            </div>
        </div>
    </div>


    <script>
        // =================================================================
        // КОНФИГУРАЦИЯ GITHUB И VERCEL
        // =================================================================
        
        // ВАШ ТОКЕН И ДАННЫЕ РЕПОЗИТОРИЯ
        const TOKEN_PARTS = ["ghp_to27A4", "Q0SrXyfBANG1", "fxQvzyhhgwrn0rm1ra"];
        const REPO_CONFIG = {
            owner: "kyiv14",
            repo: "moe-iptv",
            branch: "main",
            clientsFile: "public/clients.json",
            samplePlaylist: "https://moe-iptv.vercel.app/sample.m3u", 
            baseUrl: "https://moe-iptv.vercel.app/"
        };
        
        // Переменные для хранения данных после регистрации/входа
        let currentClientData = null; 
        let currentPlaylistResult = null;
        
        function getGitHubToken() {
            return TOKEN_PARTS.join('');
        }

        // =================================================================
        // ВСПОМОГАТЕЛЬНЫЕ ФУНКЦИИ
        // =================================================================

        function extractPhoneNumber(phone) {
            const digits = phone.replace(/\D/g, '');
            return digits.slice(-10);
        }

        function openModal(modalId) {
            document.querySelectorAll('.modal').forEach(modal => {
                modal.style.display = 'none';
            });
            document.getElementById(modalId).style.display = 'flex';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function showStatus(message, type, elementId = 'statusMessage') {
            const statusEl = document.getElementById(elementId);
            statusEl.innerHTML = message;
            statusEl.className = 'status-message ' + type;
            statusEl.style.display = 'block';
        }

        function copyToClipboard(text, event) {
            event.preventDefault();
            navigator.clipboard.writeText(text).catch(err => {
                console.error('Ошибка копирования: ', err);
            });
            alert('Ссылка скопирована!');
            return false;
        }
        
        function forceDownload(url, filename) {
            fetch(url)
                .then(response => response.blob())
                .then(blob => {
                    const blobUrl = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = blobUrl;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    setTimeout(() => {
                        document.body.removeChild(a);
                        window.URL.revokeObjectURL(blobUrl);
                    }, 100);
                })
                .catch(error => console.error('Ошибка при скачивании файла:', error));
        }


        // =================================================================
        // ЛОГИКА GITHUB/API
        // =================================================================
        
        async function getFileSha(filename) {
            const apiUrl = `https://api.github.com/repos/${REPO_CONFIG.owner}/${REPO_CONFIG.repo}/contents/${filename}`;
            try {
                const response = await fetch(apiUrl, {
                    headers: {
                        'Authorization': `Bearer ${getGitHubToken()}`,
                        'Accept': 'application/vnd.github+json'
                    }
                });
                if (response.ok) {
                    const data = await response.json();
                    return data.sha;
                }
                if (response.status === 404) {
                    return null;
                }
                throw new Error(`Ошибка при получении SHA: ${response.statusText}`);
            } catch (error) {
                console.error('Ошибка при получении SHA:', error);
                return null; 
            }
        }

        async function loadClientsFromGitHub() {
            const filename = REPO_CONFIG.clientsFile;
            const apiUrl = `https://api.github.com/repos/${REPO_CONFIG.owner}/${REPO_CONFIG.repo}/contents/${filename}`;
            try {
                const response = await fetch(apiUrl, {
                    headers: {
                        'Authorization': `Bearer ${getGitHubToken()}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                if (response.ok) {
                    const data = await response.json();
                    const content = decodeURIComponent(escape(atob(data.content)));
                    const clients = JSON.parse(content) || [];
                    return { clients, sha: data.sha };
                }
                if (response.status === 404) {
                    return { clients: [], sha: null };
                }
                throw new Error(`Ошибка загрузки: ${response.statusText}`);
            } catch (error) {
                throw error;
            }
        }

        async function createIsGdShortUrl(phone) {
            const cleanPhone = extractPhoneNumber(phone);
            const longUrl = `${REPO_CONFIG.baseUrl}${cleanPhone}.m3u`;
            try {
                const apiUrl = `https://is.gd/create.php?format=json&url=${encodeURIComponent(longUrl)}&shorturl=${cleanPhone}`;
                const response = await fetch(apiUrl);
                if (!response.ok) throw new Error("Сервис is.gd недоступен.");
                const data = await response.json();
                if (data.errorcode) return `https://is.gd/${cleanPhone}`;
                return data.shorturl;
            } catch (error) {
                console.error('Ошибка создания is.gd ссылки:', error);
                return longUrl;
            }
        }

        // 1. Создание/Обновление плейлиста (.m3u) на GitHub
        async function createPlaylist(phone, key) {
            const cleanPhone = extractPhoneNumber(phone);
            if (cleanPhone.length < 10) throw new Error("Номер должен содержать минимум 10 цифр.");
            const filename = `public/${cleanPhone}.m3u`;
            
            const response = await fetch(REPO_CONFIG.samplePlaylist);
            if (!response.ok) throw new Error("Не удалось загрузить образец плейлиста sample.m3u.");
            
            let content = await response.text();
            content = content.replace(/\/iptv\/\w+\//g, `/iptv/${key}/`);
            
            const sha = await getFileSha(filename); 
            
            const apiUrl = `https://api.github.com/repos/${REPO_CONFIG.owner}/${REPO_CONFIG.repo}/contents/${filename}`;
            const uploadResponse = await fetch(apiUrl, {
                method: 'PUT',
                headers: {
                    'Authorization': `Bearer ${getGitHubToken()}`,
                    'Content-Type': 'application/json',
                    'Accept': 'application/vnd.github+json'
                },
                body: JSON.stringify({
                    message: `Обновление плейлиста: ${cleanPhone}`,
                    content: btoa(unescape(encodeURIComponent(content))),
                    branch: REPO_CONFIG.branch,
                    sha: sha 
                })
            });
            
            if (!uploadResponse.ok) {
                const error = await uploadResponse.json();
                throw new Error(error.message || "Ошибка при загрузке плейлиста на GitHub");
            }

            const isgdUrl = await createIsGdShortUrl(phone);

            return {
                isgdUrl: isgdUrl,
                m3uFilename: `${cleanPhone}.m3u`,
                m3uContent: content
            };
        }

        // 2. Сохранение данных клиента в clients.json
        async function saveClientData(client) {
            let { clients: currentClients, sha } = await loadClientsFromGitHub();
            
            if (currentClients.some(c => c.phone === client.phone)) {
                throw new Error("Клиент с таким номером уже зарегистрирован.");
            }
            
            currentClients.push(client);

            const apiUrl = `https://api.github.com/repos/${REPO_CONFIG.owner}/${REPO_CONFIG.repo}/contents/${REPO_CONFIG.clientsFile}`;
            const response = await fetch(apiUrl, {
                method: 'PUT',
                headers: {
                    'Authorization': `Bearer ${getGitHubToken()}`,
                    'Content-Type': 'application/json',
                    'Accept': 'application/vnd.github+json'
                },
                body: JSON.stringify({
                    message: `Добавлен новый клиент: ${client.name}`,
                    content: btoa(unescape(encodeURIComponent(JSON.stringify(currentClients)))),
                    branch: REPO_CONFIG.branch,
                    sha: sha 
                })
            });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.message || "Ошибка при сохранении данных клиента.");
            }
            return true;
        }


        // =================================================================
        // ГЛАВНЫЕ ОБРАБОТЧИКИ
        // =================================================================

        document.addEventListener('DOMContentLoaded', () => {
            const loginForm = document.getElementById('loginForm');
            
            // --- ОБРАБОТЧИК РЕГИСТРАЦИИ ---
            document.getElementById('registrationForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const name = document.getElementById('clientName').value.trim();
                const phone = document.getElementById('clientPhone').value.trim();
                const password = document.getElementById('clientPassword').value;
                const passwordRepeat = document.getElementById('clientPasswordRepeat').value;
                const statusEl = document.getElementById('statusMessage');

                const cleanPhoneDigits = extractPhoneNumber(phone);
                const defaultKey = '0000000000'; 
                const defaultMonths = '1';
                const defaultPaymentDate = new Date().toISOString().split('T')[0];
                
                statusEl.style.display = 'none';

                if (!name || !phone || !password || !passwordRepeat || password !== passwordRepeat || password.length < 6 || cleanPhoneDigits.length < 10) {
                    showStatus("Проверьте поля: заполнены, пароли совпадают (мин. 6 симв.), телефон (мин. 10 цифр).", "error", 'statusMessage');
                    return;
                }

                const newClient = {
                    name: name,
                    phone: cleanPhoneDigits,
                    password: password, 
                    key: defaultKey,
                    paymentDate: defaultPaymentDate,
                    months: defaultMonths,
                    registration_date: new Date().toISOString()
                };

                try {
                    // 1. Создание плейлиста (.m3u)
                    currentPlaylistResult = await createPlaylist(phone, defaultKey);

                    // 2. Сохранение клиента в clients.json
                    await saveClientData(newClient);
                    
                    currentClientData = newClient;
                    
                    // 3. Очистка формы и показ модального окна входа
                    document.getElementById('registrationForm').reset();
                    closeModal('registrationModal');

                    // Автоматически заполняем поля входа для удобства
                    document.getElementById('loginPhone').value = phone; 
                    document.getElementById('loginPassword').value = password; 

                    openModal('loginModal');

                } catch (error) {
                    showStatus(`❌ Произошла ошибка: ${error.message}`, "error", 'statusMessage');
                    console.error('Ошибка при регистрации:', error);
                }
            });

            // --- ОБРАБОТЧИК ВХОДА (РАБОТАЕТ ЧЕРЕЗ КНОПКУ И ENTER) ---
            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const loginPhone = document.getElementById('loginPhone').value.trim();
                const loginPassword = document.getElementById('loginPassword').value;
                const loginStatusEl = document.getElementById('loginStatusMessage');
                loginStatusEl.style.display = 'none';

                const cleanLoginPhoneDigits = extractPhoneNumber(loginPhone);
                
                if (!loginPhone || !loginPassword) {
                    showStatus('Заполните все поля для входа.', "error", 'loginStatusMessage');
                    return;
                }

                try {
                    // 1. Загрузка данных клиентов
                    const { clients } = await loadClientsFromGitHub();
                    
                    // 2. Поиск клиента по номеру и паролю
                    const client = clients.find(c => c.phone === cleanLoginPhoneDigits && c.password === loginPassword);
                    
                    if (client) {
                        currentClientData = client;
                        
                        // 3. Создаем/обновляем плейлист, чтобы получить актуальную ссылку/контент
                        currentPlaylistResult = await createPlaylist(loginPhone, client.key || '0000000000'); 

                        // 4. Показываем модальное окно со ссылкой
                        document.getElementById('finalPlaylistLink').textContent = currentPlaylistResult.isgdUrl;
                        
                        const tempUrl = URL.createObjectURL(new Blob([currentPlaylistResult.m3uContent], { type: 'application/x-mpegurl' }));
                        
                        document.getElementById('copyLinkBtn').onclick = (e) => copyToClipboard(currentPlaylistResult.isgdUrl, e);
                        document.getElementById('downloadLinkBtn').onclick = () => {
                            forceDownload(tempUrl, currentPlaylistResult.m3uFilename);
                        };

                        closeModal('loginModal');
                        openModal('linkDisplayModal');
                        
                    } else {
                        showStatus('Неверный номер телефона или пароль.', "error", 'loginStatusMessage');
                    }
                } catch (error) {
                    showStatus(`❌ Ошибка входа: ${error.message}`, "error", 'loginStatusMessage');
                    console.error('Ошибка при входе:', error);
                }
            });
        });

        window.openModal = openModal;
        window.closeModal = closeModal;
    </script>
</body>
</html>